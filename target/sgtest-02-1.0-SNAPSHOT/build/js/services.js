function Totalplay(){if(Totalplay.instance)return Totalplay.instance;this.timeout=5e4,this._url=AppConfig.tp_backend.baseKanUrl,Totalplay.instance=this}Totalplay.getInstance=function(){return Totalplay.instance||(Totalplay.instance=new Totalplay),Totalplay.instance},Totalplay.prototype.setUrl=function(t){this.baseUrl=t},Totalplay.prototype.getUrl=function(t){return this.baseUrl+t},Totalplay.prototype.getProfileRequest=function(t,e){return this._makeRequest(t,"/kan-profile/",e)},Totalplay.prototype.getSMSRequest=function(t,e,o){return this._makeRequest(t,"/kan-auth/",e,o)},Totalplay.prototype.getBillingRequest=function(t,e){return this._makeRequest(t,"/kan-billing/",e)},Totalplay.prototype.getSuscriptorRequest=function(t,e){return this._makeRequest(t,"/kan-sms/suscriptor",e)},Totalplay.prototype.getStoreRequest=function(t,e,o){return this._makeRequest(t,"/app-store/"+e,o)},Totalplay.prototype.getHomeRequest=function(t,e){return this.getStoreRequest(t,"home",e)},Totalplay.prototype.getProductsRequest=function(t,e){return this.getStoreRequest(t,"products",e)},Totalplay.prototype.getPaymentRequest=function(t,e){return this.getStoreRequest(t,"payment",e)},Totalplay.prototype.getAddressRequest=function(t,e){return this.getStoreRequest(t,"address",e)},Totalplay.prototype.getBuyRequest=function(t,e){return this.getStoreRequest(t,"buy",e)},Totalplay.prototype.getGuiRequest=function(t,e,o){return this._makeRequest(t,"/kan-gui/",e,o)},Totalplay.prototype.getOrderRequest=function(t,e){return this.getStoreRequest(t,"order",e)},Totalplay.prototype.getPaymentRequest=function(t,e){return this.getStoreRequest(t,"payment",e)},Totalplay.prototype._doMakeRequest=function(s,r,a,t){var e,o,i,n={stbTs:Date.now()};switch(this._session&&(n.session=this._session),o=this._url+r+s,"S"==AppConfig.env&&"/kan-gui/"===r&&(o="http://10.1.0.102"+r+s),s){case"/getCreditInfo":case"/getProfile":case"/getDefaultShippingAddress":case"/getOrderSummary":case"/getPaymentMethods":case"/validPhoneCode":case"/sendPhoneCode":case"/buy":case"/getDetailSummary":o="https://iptvservices.totalplay.com.mx"+r+s}_.extend(n,a),"getSession"!=s&&"login"!=s&&"getAccountConfig"!=s&&"getSessionConfig"!==s&&"getSuscriptorProfiles"!==s||delete n.session;var u={url:o,method:"POST",data:decodeURIComponent(Util.serialize(n)),timeout:this.timeout,cancelToken:new axios.CancelToken(function(t){e=t}),headers:{}},p=_.extend({},t),n=(p.toJSON&&(u.data=decodeURIComponent(JSON.stringify(n)),u.headers={"Content-Type":"application/json"}),t=_.omit(t,"toJSON"),_.extend(u,t),"GET"==u.method&&(u.params=decodeURIComponent($.param(a,!0))),i=this,axios.request(u).then(function(t){return t.data}.bind(this),function(t){var e,o=ViewManager.getInstance(),n=t.response;if(!n)throw this.getErrorData({code:0});if(n.data&&((e=n.data).status=n.status),300!==n.status){switch(n.status){case 403:if(this._session=null,e&&-3==e.code)throw e;return this._session_request?this._session_request.then(function(){return i._session_request=null,i._doMakeRequest(s,r,a,p)},function(t){throw i._session_request=null,t}):this._session_request=this._getSession().then(function(){return i._session_request=null,i._doMakeRequest(s,r,a,p)},function(t){throw i._session_request=null,t});case 418:return STB.getInstance().deleteTokenFile(),this.getToken().then(function(t){return a&&(a.token=t.token),this._doMakeRequest(s,r,a,p)}.bind(this));case 401:return this._session=null,o.openView("Login"),{code:401};case 409:case 410:throw n}try{n.code=n.status,n.message=n.statusText}catch(t){throw this.getErrorData({code:500})}console.info("Catching error code: ",s)}throw n}.bind(this)));return n.cancel=e,n},Totalplay.prototype._makeRequest=function(e,o,n,s,r){var a,i,u,p=0;return s&&(a=s.retries)?(i=$.Deferred(),u=function(t){if(_.contains(Totalplay.CONTROLED_CODES,t.status))return i.reject(t);++p<a?this._doMakeRequest(e,o,n,s,r).then(i.resolve,u.bind(this)):i.reject(t)},this._doMakeRequest(e,o,n,s,r).then(i.resolve,u.bind(this)),i):this._doMakeRequest(e,o,n,s,r)},Totalplay.prototype._makeRequest=function(e,o,n,s,r){var a,i,u,p=0;return s&&(a=s.retries)?(i=$.Deferred(),u=function(t){if(_.contains(Totalplay.CONTROLED_CODES,t.status))return i.reject(t);++p<a?this._doMakeRequest(e,o,n,s,r).then(i.resolve,u.bind(this)):i.reject(t)},this._doMakeRequest(e,o,n,s,r).then(i.resolve,u.bind(this)),i):this._doMakeRequest(e,o,n,s,r)},Totalplay.prototype.saveFile=function(t,e){var o=STB.getInstance();return"object"==typeof e&&(e=JSON.stringify(e)),o.setFile(t,e)},Totalplay.prototype.getFile=function(t){return STB.getInstance().getFile(t)},Totalplay.prototype.validateProfileNip=function(t){var e={nip:Helpers.encryptNip(t.nip)},e=_.extend(t,e);return this.getProfileRequest("validateProfileNIP",e)},Totalplay.prototype.saveConfig=function(t,e){return Helpers.saveSetting(t,e)},Totalplay.prototype.getLocalToken=function(){return Util.getFile(AppConfig.token_login_file)},Totalplay.prototype._makeTPLogin=function(){return this.getToken().then(this._getSession.bind(this))},Totalplay.prototype.saveToken=function(t){var e=AppConfig.token_login_file;return Util.saveFile(e,t)},Totalplay.prototype.setSession=function(t){this._session=t},Totalplay.prototype.setToken=function(t){this._token=t},Totalplay.prototype.getToken=function(){var t,e=AppConfig.mac_address,o=e.replace(/:/gi,""),n=(Util.getSetting("pass"),Util.getUserAgent()),o={user:e,passwd:"t0ta1"+o,useragent:n,deviceid:e,ctealias:n,timestamp:Date.now(),authtype:1},e=JSON.stringify(o),n=Util.encryptByAES(e,AppConfig.tp_backend.key4).toString(),s=this;try{t=this.getLocalToken()}catch(t){console.error("Error to get local token")}return t?(this._token=t,Promise.resolve(t)):this.getSMSRequest("login",{encChain:n}).then(function(t){return s.saveToken(t.token),s._token=t.token,t})},Totalplay.prototype._getSession=function(){Util.getUserAgent();var e={token:this._token,deviceId:AppConfig.mac_address};return this.getToken().then(function(t){return e.token=t,this.getSMSRequest("getSession",e).then(function(t){return t.session&&(this._session=t.session),t}.bind(this))}.bind(this))},Totalplay.prototype.getSession=function(){return this.session},Totalplay.prototype.getProfile=function(){return this.getHomeRequest("/getProfile")},Totalplay.prototype.getDetailSummary=function(t){return this.getProductsRequest("/getDetailSummary",t).then(function(t){return t.paymentMethod?t.paymentMethod=new PaymentMethod(t.paymentMethod):t.paymentMethod=!1,t.productDetail=new Product(t.productDetail),t})},Totalplay.prototype.getAllPaymentMethods=function(t,e){return this.getPaymentRequest("/getPaymentMethods",{productId:t,idSummary:e}).then(function(t){for(var e=[],o=[],n=[],s=0;s<t.length;s++)if("totalplay"==t[s].type){for(var r=[],a=0;a<t[s].payments.length;a++)o.push(t[s].payments[a].nPayments),r.push(new PaymentMethod(t[s].payments[a]));n.push({bage:"¡LA MEJOR OFERTA!",type:t[s].type,label:"Crédito Totalplay "+o.join(", ")+" plazos",items:r})}else e.push(new PaymentMethod(t[s]));return e.push(new PaymentMethod({label:"Agregar nueva tarjeta",type:"add",addCard:!0})),n.push({type:"card",label:"Tarjeta de Crédito",img:"assets/img/icons/Opciones.png"}),{payments:n,arrCardsPayments:e}})},Totalplay.prototype.makeBuy=function(t){return this.getBuyRequest("/buy",t)},Totalplay.prototype.sendPhoneCode=function(t){return this.getBuyRequest("/sendPhoneCode",t)},Totalplay.prototype.validateSendPhoneCode=function(t,e){return this.getBuyRequest("/validPhoneCode",{secdata:t,codeSMS:e})},Totalplay.prototype.registerPurchase=function(t){return this.getGuiRequest("show/registerPurchase",t)},Totalplay.prototype.getShows=function(){return this.getGuiRequest("show/getShows",{})},Totalplay.prototype.getEventPurchase=function(t){return this.getGuiRequest("show/getEventPurchase",t)},Totalplay.prototype.getCreditInfo=function(){return this.getPaymentRequest("/getCreditInfo",{amount:0}).then(function(t){return t})},Totalplay.prototype.getDefaultShippingAddress=function(){return this.getAddressRequest("/getDefaultShippingAddress")},Totalplay.prototype.getOrderSummary=function(t,e){return this.getOrderRequest("/getOrderSummary",{productId:t,addressId:e})},Totalplay.prototype.registerCard=function(t){return this._session||(t.token=this._token),this.getPaymentRequest("/registerCard",t)};